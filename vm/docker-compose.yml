version: "3.4"

services:
  frontend:
    image: plataformamineral/p3m_frontend:2.4.3
    container_name: p3m_frontend
    user: '1000'
    environment:
      REACT_APP_PUBLIC_URL: /
      PUBLIC_URL: /
      PORT_APP: 80
      NODE_ENV: production
      CHOKIDAR_USEPOLLING: "false"
      REACT_APP_URL_BASE_API: /api
    ports:
      - 80:8080
      - 443:8443
    depends_on:
      backend:
        condition: service_started
      geoserver:
        condition: service_started
    volumes:
      - static:/usr/share/nginx/html${STATIC_URL}:ro
      - ./docker/frontend/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./docker/frontend/certificates/selfsigned.crt:/certificates/fullchain.crt:ro
      - ./docker/frontend/certificates/selfsigned.key:/certificates/privkey.key:ro

  backend:
    image: plataformamineral/p3m_backend:2.4.3
    container_name: p3m_backend
    # user: '1000'
    environment:
      DEBUG: ${DEBUG}
      DEFAULT_API_URL: "/api"
      ALLOWED_HOSTS: "frontend,${P3M_HOSTNAME}"
      STATIC_URL: ${STATIC_URL}
      STATIC_ROOT: ${STATIC_ROOT}
      SECRET_KEY_FILE: ${SECRET_KEY_FILE}
      DATABASE_URL_FILE: ${DATABASE_URL_FILE}
      CACHE_ENABLED: true
      CACHE_LOCATION: memcached:11211
      LOAD_FIXTURES: ${LOAD_FIXTURES}
    depends_on:
      postgis:
        condition: service_healthy
      memcached:
        condition: service_healthy
    # healthcheck:
    #   # Define uma rota especÃ­fica para healthcheck em uwsgi.ini
    #   test: ["CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:8000/api || exit 1"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 2
    #   start_period: 30s
    volumes:
      - static:${STATIC_ROOT}
      - ./docker/backend/default_url.txt:${DATABASE_URL_FILE}:ro
      - ./docker/backend/secret_key.txt:${SECRET_KEY_FILE}:ro
      - ./docker/backend/uwsgi.ini:/usr/src/app/uwsgi.ini:ro

  geoserver:
    image: ndscprm/geoserver:2.24.4
    container_name: p3m_geoserver
    user: '1000'
    volumes:
      - ./docker/geoserver/data:/srv/geoserver/data
      - ./docker/geoserver/fonts:/usr/share/fonts/p3m:ro
    environment:
      JAVA_OPTS: >-
        -server 
        -Djava.awt.headless=true 
        -Xms3G 
        -Xmx4G
      CATALINA_OPTS: >-
        -XX:PerfDataSamplingInterval=500
        -XX:SoftRefLRUPolicyMSPerMB=36000 
        -XX:NewRatio=2
        -XX:+UseG1GC
        -XX:+UseStringDeduplication 
        -XX:InitiatingHeapOccupancyPercent=70
        -XX:+CMSClassUnloadingEnabled
      GEOSERVER_OPTS: >-
        -Dorg.geotools.referencing.forceXY=true 
        -Dorg.geotools.shapefile.datetime=true 
        -Dgeoserver.login.autocomplete=off
        -Doracle.jdbc.timezoneAsRegion=false 
      GEOSERVER_NODE_OPTS: id:MASTER;background:red;color:white
      PROXY_BASE_URL: http://${P3M_HOSTNAME}/geoserver
      GEOSERVER_CSRF_DISABLED: true

  memcached:
    image: memcached:alpine
    container_name: p3m_memcached
    restart: unless-stopped
    healthcheck:
      test: nc -z 127.0.0.1 11211
      interval: 30s
      timeout: 30s
      retries: 5
      start_period: 30s

  postgis:
    image: postgis/postgis:14-3.4-alpine
    container_name: p3m_db
    environment:
      POSTGRES_PASSWORD: p3mdb
      POSTGRES_USER: p3m
      POSTGRES_DB: p3m
    ports:
      - 5432:5432
    volumes:
      - dbdata:/var/lib/postgresql/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "sh -c 'pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}'"]
      interval: 30s
      timeout: 10s
      retries: 2
      start_period: 30s

volumes:
  dbdata:
  static:
